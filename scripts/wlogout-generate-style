#!/usr/bin/env python3
import json, os, sys

home = os.path.expanduser("~")
wal_json = os.path.join(home, ".cache", "wal", "colors.json")
out_css = os.path.join(home, ".config", "wlogout", "style.css")
blur_path = "./images/wallpaper_blurred.png"

# fallback colors if pywal missing
fallback = {
  "background": "#0b0b0b",
  "foreground": "#e6eef6",
  "accent": "#89b4fa",
  "color0": "#0b0b0b",
  "color7": "#e6eef6"
}

data = {}
if os.path.exists(wal_json):
    try:
        data = json.load(open(wal_json))
    except Exception:
        data = {}
# helpers to pick safe values
def get_special(key, default):
    sp = data.get("special") or data.get("special", {})
    return sp.get(key) or data.get(key) or default

background = get_special("background", fallback["background"])
foreground = get_special("foreground", fallback["foreground"])
accent = (data.get("colors") and (data.get("colors").get("7") if isinstance(data.get("colors"), dict) else (data.get("colors")[7] if len(data.get("colors"))>7 else None))) or fallback["accent"]

css = f'''/* Generated wlogout style (GTK-compatible) */
* {{
  font-family: "JetBrains Mono", monospace;
  font-size: 18px;
  color: {foreground};
}}

window {{
  background-image: url("{blur_path}");
  background-size: cover;
  background-position: center;
}}

#panel {{
  background-color: rgba(0,0,0,0.45);
  border-radius: 14px;
  padding: 18px;
  margin: 24px;
  box-shadow: 0 6px 40px rgba(0,0,0,0.6);
}}

button {{
  border-radius: 12px;
  padding: 12px 16px;
  margin: 8px;
  min-width: 160px;
  display: inline-flex;
  align-items: center;
  gap: 12px;
  color: {foreground};
  background-color: rgba(0,0,0,0.35);
  border: 1px solid rgba(255,255,255,0.03);
}}

button .icon {{
  width: 36px;
  height: 36px;
  background-repeat: no-repeat;
  background-size: contain;
  flex-shrink: 0;
}}

button span {{
  font-size: 1.05em;
  line-height: 1;
  white-space: nowrap;
}}

button:hover, button:focus {{
  transform: translateY(-4px);
  background-color: rgba(255,255,255,0.04);
  border: 1px solid {accent};
  color: {accent};
  transition: all 140ms cubic-bezier(.2,.9,.2,1);
}}

#lock .icon    {{ background-image: url("./icons/lock.png"); }}
#logout .icon  {{ background-image: url("./icons/logout.png"); }}
#suspend .icon {{ background-image: url("./icons/sleep.png"); }}
#shutdown .icon{{ background-image: url("./icons/power.png"); }}
#reboot .icon  {{ background-image: url("./icons/restart.png"); }}
#hibernate .icon {{ background-image: url("./icons/hibernate.png"); }}

#hint {{
  color: rgba(255,255,255,0.75);
  font-size: 13px;
  text-align: center;
  margin-top: 8px;
}}
'''
# write file
os.makedirs(os.path.dirname(out_css), exist_ok=True)
with open(out_css, "w", encoding="utf-8") as f:
    f.write(css)
print("wlogout style written to", out_css)
